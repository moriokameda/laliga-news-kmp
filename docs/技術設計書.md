# ラリーガニュースアプリ 技術設計書

## 1. システム概要

### 1.1 アーキテクチャ方針
- **プラットフォーム**: Kotlin Multiplatform (KMP)
- **UIフレームワーク**: Compose Multiplatform
- **アーキテクチャパターン**: MVVM (Model-View-ViewModel)
- **データ層**: Repository Pattern
- **状態管理**: ViewModel + StateFlow

### 1.2 技術スタック
- **言語**: Kotlin
- **ビルドシステム**: Gradle (Kotlin DSL)
- **HTTPクライアント**: Ktor Client
- **JSON処理**: kotlinx.serialization
- **画像読み込み**: Coil (Compose Multiplatform)
- **非同期処理**: Kotlin Coroutines
- **依存性注入**: Koin (将来実装)

## 2. システムアーキテクチャ

### 2.1 レイヤー構成
```
┌─────────────────────────────────────┐
│              UI Layer               │
│  (Compose Screens + ViewModels)     │
├─────────────────────────────────────┤
│            Domain Layer             │
│         (Use Cases)                 │
├─────────────────────────────────────┤
│             Data Layer              │
│    (Repository + Data Sources)      │
└─────────────────────────────────────┘
```

### 2.2 モジュール構成
```
composeApp/
├── src/commonMain/kotlin/
│   ├── data/               # データ層
│   │   ├── repository/     # Repository実装
│   │   ├── remote/         # API通信
│   │   ├── local/          # ローカルキャッシュ
│   │   └── model/          # データモデル
│   ├── domain/             # ドメイン層
│   │   ├── model/          # エンティティ
│   │   ├── repository/     # Repository interface
│   │   └── usecase/        # ユースケース
│   ├── presentation/       # プレゼンテーション層
│   │   ├── screen/         # 画面
│   │   ├── viewmodel/      # ViewModel
│   │   └── component/      # 共通UI部品
│   └── util/               # ユーティリティ
├── src/androidMain/        # Android固有実装
└── src/iosMain/           # iOS固有実装
```

## 3. データ設計

### 3.1 データモデル

#### NewsArticle (ニュース記事)
```kotlin
data class NewsArticle(
    val id: String,
    val title: String,
    val summary: String,
    val content: String,
    val imageUrls: List<String>,
    val publishedAt: LocalDateTime,
    val source: String,
    val originalLanguage: String,
    val isTranslated: Boolean
)
```

#### NewsListState (一覧画面状態)
```kotlin
sealed class NewsListState {
    object Loading : NewsListState()
    data class Success(val articles: List<NewsArticle>) : NewsListState()
    data class Error(val message: String) : NewsListState()
    object Empty : NewsListState()
}
```

### 3.2 データフロー
```
サンプルデータ → Repository → UseCase → ViewModel → UI
     ↑              ↓
   翻訳処理     ← キャッシュ管理
```

### 3.3 キャッシュ戦略
- **メモリキャッシュ**: 現在表示中のニュース記事（最大20件）
- **画像キャッシュ**: 表示済み画像（最大50MB、Coilによる自動管理）
- **データ保持期間**: 1週間（起動時に自動削除）
- **更新タイミング**: アプリ起動時、プルリフレッシュ時

## 4. 機能設計

### 4.1 ニュース取得機能

#### 4.1.1 サンプルデータ仕様
- **件数**: 10件
- **内容**: ダミーのラリーガニュース
- **画像**: サンプル画像10枚（各記事1枚ずつ）
- **言語**: 日本語3件、英語4件、スペイン語3件

#### 4.1.2 データ生成ロジック
```kotlin
class SampleNewsRepository {
    fun getNewsArticles(): Flow<List<NewsArticle>> {
        // サンプルデータ生成
        // 英語/スペイン語記事の翻訳処理
        // キャッシュ管理
    }
}
```

### 4.2 翻訳機能（将来実装）

#### 4.2.1 翻訳フロー
1. 記事の言語検出
2. 日本語以外の場合、翻訳API呼び出し
3. 翻訳成功: 日本語記事として保存
4. 翻訳失敗: 原文のまま表示（isTranslated: false）

#### 4.2.2 翻訳品質
- **要求水準**: 意味が理解できるレベル
- **エラー処理**: 翻訳失敗時は原文表示
- **キャッシュ**: 翻訳済み記事のキャッシュ

### 4.3 画像処理機能

#### 4.3.1 画像最適化
- **圧縮**: 表示サイズに応じた自動リサイズ
- **フォーマット**: WebP優先、フォールバックJPEG
- **読み込み優先度**: 
  - 一覧: 低解像度（80dp × 80dp）
  - 詳細: 高解像度（画面幅まで）

#### 4.3.2 画像キャッシュ
```kotlin
// Coil設定例
ImageLoader.Builder(context)
    .memoryCache {
        MemoryCache.Builder(context)
            .maxSizePercent(0.25) // メモリの25%まで
            .build()
    }
    .diskCache {
        DiskCache.Builder()
            .directory(context.cacheDir.resolve("image_cache"))
            .maxSizeBytes(50 * 1024 * 1024) // 50MB
            .build()
    }
```

## 5. パフォーマンス設計

### 5.1 レスポンス時間目標
- **アプリ起動**: 2秒以内
- **ニュース一覧表示**: 2秒以内
- **記事詳細表示**: 1秒以内
- **プルリフレッシュ**: 3秒以内

### 5.2 最適化戦略

#### 5.2.1 初期表示最適化
- スケルトンUI表示（即座）
- バックグラウンドでデータ取得
- 画像遅延読み込み

#### 5.2.2 スクロール最適化
- LazyColumn使用
- 画像の段階的読み込み
- ViewRecycling

#### 5.2.3 メモリ管理
- 画面外の画像は自動解放
- 大きな画像のサンプリング
- 適切なGC呼び出し

### 5.3 同時処理制限
- **同時画像読み込み**: 最大6枚
- **HTTPリクエスト**: 最大3並列
- **翻訳処理**: 最大2並列

## 6. エラーハンドリング設計

### 6.1 エラー分類と対応

#### 6.1.1 ネットワークエラー
```kotlin
sealed class NetworkError : Exception() {
    object NoConnection : NetworkError()
    object Timeout : NetworkError()
    object ServerError : NetworkError()
}
```

**対応策**:
- 初回: 即座にエラー表示
- リトライ: 10秒後に自動再試行（最大3回）
- ユーザー通知: "ネットワークが重くなっています"

#### 6.1.2 データエラー
- **翻訳失敗**: 原文表示
- **画像読み込み失敗**: ラリーガロゴ表示
- **JSONパースエラー**: デフォルト値使用

#### 6.1.3 UI状態管理
```kotlin
data class UiState<T>(
    val data: T? = null,
    val isLoading: Boolean = false,
    val error: String? = null,
    val isRefreshing: Boolean = false
)
```

### 6.2 ログ管理
- **開発時**: 詳細ログ出力
- **本番時**: エラーログのみ
- **クラッシュ報告**: 将来実装予定

## 7. セキュリティ設計

### 7.1 データ保護
- **機密データ**: なし（パブリックニュースのみ）
- **画像URL**: HTTPS必須
- **キャッシュ**: アプリ削除時に自動削除

### 7.2 ネットワークセキュリティ
- **SSL/TLS**: 1.2以上必須
- **証明書検証**: 標準設定
- **APIキー**: 環境変数管理（将来実装時）

## 8. 国際化・多言語対応

### 8.1 UI言語
- **固定言語**: 日本語のみ
- **ロケール設定**: 無視（常に日本語表示）
- **フォント**: システムデフォルト日本語フォント使用

### 8.2 コンテンツ言語
- **優先言語**: 日本語
- **翻訳対象**: 英語・スペイン語記事
- **翻訳エンジン**: Google Translate API（将来実装）

## 9. 監視・運用設計

### 9.1 パフォーマンス監視
- **起動時間計測**: 開発版のみ
- **メモリ使用量監視**: デバッグ時のみ
- **クラッシュレート**: 将来実装

### 9.2 ログレベル
```kotlin
enum class LogLevel {
    DEBUG,   // 開発時詳細ログ
    INFO,    // 一般情報
    WARN,    // 警告
    ERROR    // エラーのみ（本番）
}
```

## 10. デプロイ・配布設計

### 10.1 ビルド設定
- **Debug版**: 開発・テスト用
- **Release版**: 配布用（最適化済み）
- **署名**: プラットフォーム標準

### 10.2 配布方法
- **Android**: APKファイル
- **iOS**: 開発者向け配布
- **ストア公開**: 将来検討

## 11. 将来拡張設計

### 11.1 拡張可能なコンポーネント
- **ニュースソース**: 複数API対応可能
- **フィルタリング**: チーム別表示
- **ストレージ**: お気に入り機能
- **通知**: プッシュ通知

### 11.2 技術的準備
- **DI準備**: Koin導入予定
- **データベース**: Room/SQLDelight検討
- **ネットワーク**: Retrofit切り替え可能

---
作成日: 2025-07-22
バージョン: 1.0