# ラリーガニュースアプリ バックエンド構成と実装ガイド

## 1. 選定技術スタック

### 1.1 バックエンドフレームワーク: Ktor

#### 選定理由
- **Kotlin-first設計**: Kotlin Multiplatformとの完璧な統合
- **軽量・高速**: 最小限のオーバーヘッドで高パフォーマンス
- **非同期処理**: Kotlinコルーチンによる効率的な並行処理
- **モジュラー設計**: 必要な機能だけを選択可能
- **学習コスト**: Spring Bootより簡潔でKotlin開発者に優しい

#### Spring Bootとの比較
| 観点 | Ktor | Spring Boot |
|------|------|-------------|
| 起動時間 | 高速（秒単位） | 遅い（数十秒） |
| メモリ使用量 | 少ない | 多い |
| 設定の複雑さ | シンプル | 複雑（アノテーション多数） |
| Kotlin対応 | ネイティブ | Java中心 |
| 適用規模 | 小〜中規模 | 中〜大規模 |

### 1.2 翻訳API: Microsoft Translator

#### コスト分析
```
月間想定使用量計算:
- 1記事あたり: 500文字（タイトル50 + 要約150 + 本文300）
- 1日あたり: 20記事 × 500文字 = 10,000文字
- 月間: 10,000文字 × 30日 = 300,000文字

Microsoft Translator無料枠: 2,000,000文字/月
→ 6.6倍の余裕があり、完全無料で運用可能
```

#### 他サービスとの比較
| サービス | 無料枠 | 超過料金 | 翻訳品質 | セットアップ |
|---------|--------|----------|----------|-------------|
| **Microsoft Translator** | 200万文字/月 | $10/100万文字 | 高 | 簡単 |
| Google Cloud Translation | 50万文字/月 | $20/100万文字 | 高 | 中 |
| LibreTranslate | 無制限 | なし | 中 | 複雑（自己ホスト） |
| MyMemory | 5万文字/日 | なし | 中〜高 | 簡単 |

### 1.3 データベース: Supabase

#### 選定理由
- **PostgreSQL基盤**: 構造化データに最適、SQLの豊富な機能
- **リアルタイム機能**: 新着ニュースの即時配信が可能
- **認証機能内蔵**: 将来的なユーザー管理に対応
- **オープンソース**: ベンダーロックインなし
- **無料枠が充実**: 500MB DB + 1GB ストレージ

## 2. システムアーキテクチャ

### 2.1 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                     クライアントアプリ                          │
│  ┌─────────────┐                      ┌─────────────┐      │
│  │   iOS App   │                      │ Android App │      │
│  │  (Swift UI) │                      │  (Compose)  │      │
│  └──────┬──────┘                      └──────┬──────┘      │
│         │                                     │             │
│         └─────────────┬───────────────────────┘             │
│                       │                                     │
│                   Shared Module                             │
│               (Kotlin Multiplatform)                        │
└───────────────────────┼─────────────────────────────────────┘
                        │ HTTPS/REST
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                    Ktor Backend                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                  REST API Layer                      │  │
│  │  ├── /api/news          (ニュース一覧取得)           │  │
│  │  ├── /api/news/:id      (ニュース詳細取得)           │  │
│  │  ├── /api/news/refresh  (最新ニュース更新)           │  │
│  │  └── /api/favorites     (お気に入り管理)             │  │
│  └─────────────────────────────────────────────────────┘  │
│                           │                                 │
│  ┌────────────────────────┼────────────────────────────┐  │
│  │                Service Layer                         │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │  │
│  │  │News Service │  │Translation  │  │  Cache     │ │  │
│  │  │            │  │  Service    │  │  Service   │ │  │
│  │  └─────────────┘  └─────────────┘  └────────────┘ │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────┬──────────────────┬─────────────────────────────┘
             │                  │
    ┌────────▼────────┐ ┌───────▼────────┐
    │  External APIs  │ │   Supabase     │
    │  ┌───────────┐ │ │  ┌──────────┐  │
    │  │ News API  │ │ │  │PostgreSQL│  │
    │  └───────────┘ │ │  └──────────┘  │
    │  ┌───────────┐ │ │  ┌──────────┐  │
    │  │Microsoft  │ │ │  │Realtime  │  │
    │  │Translator │ │ │  │  (新着)   │  │
    │  └───────────┘ │ │  └──────────┘  │
    └─────────────────┘ └────────────────┘
```

### 2.2 データフロー

```
1. ニュース取得フロー:
   Client → Ktor → Cache確認 → あれば返却
                      ↓
                   なければ → News API → 翻訳判定
                                           ↓
                                      必要なら翻訳
                                           ↓
                                      Supabaseに保存
                                           ↓
                                      Clientに返却

2. リアルタイム更新フロー:
   定期バッチ → News API → 新規記事検出 → 翻訳 → Supabase
                                               ↓
                                          Realtime配信
                                               ↓
                                          接続中のClient
```

## 3. Ktor実装詳細

### 3.1 プロジェクト構造

```
ktor-backend/
├── build.gradle.kts
├── src/main/kotlin/
│   ├── Application.kt          # メインエントリポイント
│   ├── config/
│   │   ├── AppConfig.kt       # 環境設定
│   │   └── DatabaseConfig.kt  # DB接続設定
│   ├── routes/
│   │   ├── NewsRoutes.kt      # ニュースAPI
│   │   └── FavoriteRoutes.kt  # お気に入りAPI
│   ├── services/
│   │   ├── NewsService.kt     # ビジネスロジック
│   │   ├── TranslationService.kt
│   │   └── CacheService.kt
│   ├── models/
│   │   ├── News.kt           # データモデル
│   │   └── ApiResponse.kt    # レスポンス型
│   ├── repositories/
│   │   └── NewsRepository.kt  # データアクセス層
│   └── utils/
│       ├── Extensions.kt      # 拡張関数
│       └── ErrorHandling.kt   # エラー処理
```

### 3.2 基本実装

#### Application.kt
```kotlin
fun main() {
    embeddedServer(Netty, port = 8080) {
        configureRouting()
        configureSerialization()
        configureMonitoring()
        configureSecurity()
        configureDatabase()
    }.start(wait = true)
}

fun Application.configureRouting() {
    routing {
        route("/api") {
            newsRoutes()
            favoriteRoutes()
        }
    }
}

fun Application.configureSerialization() {
    install(ContentNegotiation) {
        json(Json {
            prettyPrint = true
            isLenient = true
            ignoreUnknownKeys = true
        })
    }
}
```

#### NewsService.kt
```kotlin
class NewsService(
    private val newsApiClient: NewsApiClient,
    private val translationService: TranslationService,
    private val repository: NewsRepository,
    private val cacheService: CacheService
) {
    suspend fun getLatestNews(
        language: String = "ja",
        forceRefresh: Boolean = false
    ): List<News> {
        // キャッシュチェック
        if (!forceRefresh) {
            cacheService.getCachedNews()?.let { return it }
        }
        
        // 外部APIから取得
        val rawNews = newsApiClient.fetchLatestNews("la liga")
        
        // 翻訳処理
        val translatedNews = rawNews.map { article ->
            if (article.language != language && language == "ja") {
                translationService.translateArticle(article)
            } else {
                article
            }
        }
        
        // DBに保存
        repository.saveNews(translatedNews)
        
        // キャッシュ更新
        cacheService.updateCache(translatedNews)
        
        return translatedNews
    }
}
```

### 3.3 Microsoft Translator統合

```kotlin
class MicrosoftTranslatorService(
    private val apiKey: String = System.getenv("TRANSLATOR_API_KEY")
) {
    private val client = HttpClient {
        install(ContentNegotiation) {
            json()
        }
        defaultRequest {
            header("Ocp-Apim-Subscription-Key", apiKey)
            header("Content-Type", "application/json")
        }
    }
    
    suspend fun translate(
        texts: List<String>,
        targetLanguage: String = "ja",
        sourceLanguage: String? = null
    ): List<String> {
        val response = client.post("https://api.cognitive.microsofttranslator.com/translate") {
            parameter("api-version", "3.0")
            parameter("to", targetLanguage)
            sourceLanguage?.let { parameter("from", it) }
            
            setBody(texts.map { TranslateRequest(it) })
        }
        
        return response.body<List<TranslateResponse>>()
            .map { it.translations.first().text }
    }
    
    // バッチ翻訳の最適化
    suspend fun translateBatch(articles: List<NewsArticle>): List<NewsArticle> {
        val textsToTranslate = articles.flatMap { 
            listOf(it.title, it.summary) 
        }
        
        // Microsoft Translatorは100テキストまで一度に翻訳可能
        val translatedTexts = textsToTranslate.chunked(100).flatMap { batch ->
            translate(batch)
        }
        
        return articles.mapIndexed { index, article ->
            article.copy(
                title = translatedTexts[index * 2],
                summary = translatedTexts[index * 2 + 1],
                isTranslated = true
            )
        }
    }
}
```

### 3.4 Supabase統合

```kotlin
class SupabaseNewsRepository(
    private val supabaseUrl: String = System.getenv("SUPABASE_URL"),
    private val supabaseKey: String = System.getenv("SUPABASE_ANON_KEY")
) : NewsRepository {
    
    private val client = createSupabaseClient(supabaseUrl, supabaseKey) {
        install(Postgrest)
        install(Realtime)
    }
    
    override suspend fun getAllNews(limit: Int): List<News> {
        return client.postgrest["news"]
            .select()
            .order("published_at", Order.DESCENDING)
            .limit(limit)
            .decodeList()
    }
    
    override suspend fun saveNews(news: List<News>) {
        client.postgrest["news"]
            .upsert(news)
            .execute()
    }
    
    // リアルタイム新着ニュース配信
    suspend fun subscribeToNewArticles(onNewArticle: (News) -> Unit) {
        val channel = client.realtime.createChannel("news-updates")
        
        channel.postgresChangeFlow<News>(schema = "public") {
            table = "news"
            filter = "published_at=gte.${Instant.now()}"
        }.collect { change ->
            when (change) {
                is PostgresAction.Insert -> onNewArticle(change.record)
                else -> {}
            }
        }
        
        channel.subscribe()
    }
}
```

## 4. デプロイメント戦略

### 4.1 無料ホスティングオプション

#### 開発・テスト環境
1. **Render.com**
   - 無料プラン: 750時間/月
   - 自動スリープあり
   - PostgreSQL無料プラン付き

2. **Railway.app**
   - $5分のクレジット/月
   - 簡単なデプロイ
   - 環境変数管理

#### 本番環境（小規模）
1. **Google Cloud Run**
   - 200万リクエスト/月まで無料
   - 自動スケーリング
   - コールドスタートあり

2. **AWS Lambda + API Gateway**
   - 100万リクエスト/月まで無料
   - サーバーレス
   - Ktor用アダプター必要

### 4.2 環境変数設定

```env
# .env.example
# News API
NEWS_API_KEY=your_news_api_key
NEWS_API_BASE_URL=https://newsapi.org/v2

# Microsoft Translator
TRANSLATOR_API_KEY=your_translator_key
TRANSLATOR_REGION=japaneast

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key

# App Config
PORT=8080
ENVIRONMENT=development
CACHE_TTL_MINUTES=30
```

## 5. セキュリティ考慮事項

### 5.1 API保護
```kotlin
fun Application.configureSecurity() {
    // レート制限
    install(RateLimit) {
        register {
            rateLimiter(limit = 100, refillPeriod = 60.seconds)
        }
    }
    
    // CORS設定
    install(CORS) {
        allowHost("localhost:3000")
        allowHost("your-app.com")
        allowCredentials = true
        allowHeader(HttpHeaders.ContentType)
    }
    
    // API Key認証（オプション）
    install(Authentication) {
        apiKey("api-key") {
            validate { apiKey ->
                if (apiKey == System.getenv("CLIENT_API_KEY")) {
                    ApiPrincipal(apiKey)
                } else null
            }
        }
    }
}
```

### 5.2 データ検証
```kotlin
@Serializable
data class NewsRequest(
    @SerialName("language")
    val language: String = "ja",
    
    @SerialName("limit")
    @Serializable(with = LimitSerializer::class)
    val limit: Int = 20
)

object LimitSerializer : KSerializer<Int> {
    override fun deserialize(decoder: Decoder): Int {
        val value = decoder.decodeInt()
        return value.coerceIn(1, 100) // 最大100件に制限
    }
}
```

## 6. モニタリングとロギング

### 6.1 基本的なロギング
```kotlin
fun Application.configureMonitoring() {
    install(CallLogging) {
        level = Level.INFO
        filter { call -> call.request.path().startsWith("/api") }
    }
    
    // メトリクス収集
    install(MicrometerMetrics) {
        registry = PrometheusMeterRegistry(PrometheusConfig.DEFAULT)
    }
}
```

### 6.2 エラー追跡
```kotlin
fun Application.configureErrorHandling() {
    install(StatusPages) {
        exception<Throwable> { call, cause ->
            when (cause) {
                is ValidationException -> {
                    call.respond(
                        HttpStatusCode.BadRequest,
                        ErrorResponse(cause.message ?: "Validation failed")
                    )
                }
                is NotFoundException -> {
                    call.respond(
                        HttpStatusCode.NotFound,
                        ErrorResponse(cause.message ?: "Resource not found")
                    )
                }
                else -> {
                    logger.error("Unhandled error", cause)
                    call.respond(
                        HttpStatusCode.InternalServerError,
                        ErrorResponse("Internal server error")
                    )
                }
            }
        }
    }
}
```

## 7. 開発開始チェックリスト

### 環境準備
- [ ] Kotlin 1.9+とJDK 17+のインストール
- [ ] IntelliJ IDEA/Android Studioのセットアップ
- [ ] Postman/Insomnia等のAPIテストツール準備

### アカウント作成
- [ ] Microsoft Azure アカウント作成（Translator API用）
- [ ] Supabase アカウント作成とプロジェクト作成
- [ ] ニュースAPI選定とキー取得

### 初期実装
- [ ] Ktorプロジェクトの初期化
- [ ] 基本的なルーティング設定
- [ ] データモデルの定義
- [ ] 外部API統合のテスト
- [ ] データベース接続の確認

### テスト
- [ ] ユニットテストの作成
- [ ] 統合テストの実装
- [ ] 負荷テストの実施
- [ ] セキュリティテスト

---
作成日: 2025-07-31
バージョン: 1.0